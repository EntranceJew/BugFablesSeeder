<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.css" integrity="sha256-46qynGAkLSFpVbEBog43gvNhfrOj+BmwXdxFgVK/Kvc=" crossorigin="anonymous" />
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/vue-select.css" />
    <link rel="stylesheet" href="css/main.css" />

    <title>Bug Fable Seeder</title>
</head>
<body class="bg-light">
<div class="container" id="bug-save-app">
    <div class="row">
        <div class="col col-3">
            <div id="drop_zone" class="text-center" v-on:drop="dropHandler" v-on:dragover="dragOverHandler">
                <p>[drop Bug Fables saveN.dat here]</p>
            </div>
        </div>
        <div class="col col-3">
            <div class="custom-control custom-checkbox checkbox-lg">
                <input type="checkbox" class="custom-control-input" id="spoilers" v-model="spoilers">
                <label class="custom-control-label" for="spoilers">Spoilers?</label>
            </div>
            <br/>
            <div class="btn-group" role="group" aria-label="Basic example">
                <button type="button" class="btn btn-secondary" @click="save">
                    <i class="fas fa-file-download"></i> Save
                </button>
                <button type="button" class="btn btn-secondary" @click="reset">
                    <i class="fas fa-toilet-paper"></i> Reset
                </button>
                <button type="button" class="btn btn-secondary" @click="generate_from_seed()">
                    <i class="fas fa-seedling"></i> Generate
                </button>
            </div>
            <br/>
            <label for="seed">Seed:</label>
            <input id="seed" name="seed" v-model="seed" placeholder="seed" />
        </div>
        <div class="col col-3">
            <label for="generator">Medal Generator:</label>
            <select id="generator" name="generator" v-model="badge_generator_selection" @change="generate_badge($event)">
                <option disabled value="">Please select one</option>
                <option v-for="badge in badge_data" v-bind:value="badge.id">
                    {{ badge.name }}
                </option>
            </select>
            <draggable @start="hideTips" class="medal-zone" v-model="badge_generator_inventory" group="medals" >
                <bug-medal v-for="medal in badge_generator_inventory"
                           :medal="medal"
                           :key="medal.id">
                </bug-medal>
            </draggable>
        </div>
        <div class="col col-3">
            <div class="row h-100">
                <div class="col-sm-12 my-auto">
                    <img class="img-fluid" src="images/logo.png"/>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="card col col-12">
            <div class="card-body">
                <h5 class="card-title">
                    Party Info
                </h5>
                <h6 class="card-subtitle mb-2 text-muted">We can see you cheating berries.</h6>
                <form class="needs-validation">
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label for="player-name">Player Name</label>
                            <input type="text" class="form-control" id="player-name" :value="bug_save.profile_name"/>
                        </div>
                        <div class="col-6 mb-3">
                            <label for="berries-wallet">Berries (Wallet)</label>
                            <input type="number" class="form-control" id="berries-wallet" :value="bug_save.party_stats.money"/>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col col-2">
            MYSTERY? Medals:
        </div>
        <draggable @start="hideTips" class="col col-10 medal-zone" v-model="bug_save.mystery_medals" group="medals" >
            <bug-medal v-for="medal in bug_save.mystery_medals"
                       :medal="medal"
                       :key="medal.id">
            </bug-medal>
        </draggable>
    </div>
    <div class="row" v-for="(shop, index) in bug_save.badge_shops">
        <div class="col col-2">
            {{ game_data.shop_names[index] }}'s Shop:
        </div>
        <draggable @start="hideTips" class="col col-10 medal-zone" v-model="bug_save.badge_shops[index]" group="medals" >
            <bug-medal v-for="medal in bug_save.badge_shops[index]"
                       :medal="medal"
                       :key="medal.id">
            </bug-medal>
        </draggable>
    </div>
    <div class="row">
        <div class="col col-2">
            Unequipped Medals:
        </div>
        <draggable @start="hideTips" class="col col-10 medal-zone" v-model="bug_save.medals_inventory" group="medals" >
            <bug-medal v-for="medal in bug_save.medals_inventory"
                       :medal="medal"
                       :key="medal.id">
            </bug-medal>
        </draggable>
    </div>
    <div class="row">
        <div class="col col-2">
            Party's Medals:
        </div>
        <draggable @start="hideTips" class="col col-10 medal-zone" v-model="bug_save.medals_party" group="medals" >
            <bug-medal v-for="medal in bug_save.medals_party"
                       :medal="medal"
                       :key="medal.id">
            </bug-medal>
        </draggable>
    </div>
    <div class="row" v-for="character in bug_save.characters" v-show="character">
        <div class="col col-2">
            {{ game_data.character_names[character.trueid] }}'s Medals:
        </div>
        <draggable @start="hideTips" class="col col-10 medal-zone" v-model="character.medals" group="medals" >
            <bug-medal v-for="medal in character.medals"
                       :medal="medal"
                       :key="medal.id">
            </bug-medal>
        </draggable>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/js/all.min.js" integrity="sha256-qM7QTJSlvtPSxVRjVWNM2OfTAz/3k5ovHOKmKXuYMO4=" crossorigin="anonymous"></script>
<script src="js/vue.min.js"></script>
<script src="js/jquery-3.4.1.min.js"></script>
<script src="js/bootstrap.bundle.min.js"></script>
<script src="js/Sortable.min.js"></script>
<script src="js/vuedraggable.umd.min.js"></script>
<script src="js/vue-select.js"></script>
<script src="js/seededshuffle.js"></script>
<script src="js/main.js"></script>
<script type="application/javascript">
    Vue.component('bug-medal', {
        props: ['medal'],
        template: `<img
            :src='medal.secret ? "images/mystery.png" : "images/medals/"+medal.medal_id+".png"'
            :alt='"#"+medal.medal_id+" ("+medal.name+")"'
            @click='onClick'
            :data-original-title='getTitle()' data-toggle="tooltip" data-html="true"
        />`,
        methods: {
            onClick () {
                this.medal.secret = !this.medal.secret;
                this.$root.resetTooltips();
            },
            getTitle() {
                return this.medal.secret ? `
                <h5>Mystery Medal</h5>
                <h6>#???</h6>
                <br/>
                <span>Click to reveal real badge.</span>
                ` : `
                <h5>${this.medal.name}</h5>
                <h6>#${this.medal.medal_id}</h6>
                <br/>
                <span>${this.medal.description}</span>
                `;
            }
        }
    });

    // noinspection JSUnusedGlobalSymbols
    var bugApp = new Vue({
        el: '#bug-save-app',
        components: {
            vuedraggable
        },
        data: {
            seed: new Date().getTime(),
            tooltips: null,
            spoilers: false,
            file_name: 'save0.dat',
            game_data: {
                encryption_key: 543,
                mystery_badge_limit: 106,
                character_count: 3,
                medal_shops_count: 2,
                character_names: [
                    'Vi',
                    'Kabbu',
                    'Leif'
                ],
                shop_names: [
                    'Merab',
                    'Shades'
                ],
                description_find_replace: {
                    ['|menu,46|']: 'Vi',
                    ['|menu,47|']: 'Kabbu',
                    ['|menu,48|']: 'Leif',
                    ['|pauseline|']: '<span class="pause-line">',
                    ['|unpauseline|']: '</span>',
                    ['|shopline|']: "\n<br/>",
                },
                mystery_medal_distribution: [0,0,0,0,0,0,1,1,1,1,1,2,3,3,4,4,5,6,6,7,7,8,9,9,10,12,12,13,14,15,16,17,18,19,19,20,21,21,22,23,24,25,26,27,28,29,30,31,32,33,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,49,50,50,51,52,53,54,55,56,56,57,58,59,60,61,61,62,62,63,63,64,64,65,65,66,67,68,69,70,71,72,73,74,74,75,76,77,78,79],
            },
            drag_data: {},
            badge_data: {},
            badge_generator_selection: null,
            badge_generator_inventory: [],
            bug_save: {
                party_stats: {
                    money: 0,
                },
            },
            proto_bug_save: {
                mystery_medals: [],
                profile_name: "",
                characters: [],
                party_stats: {
                    money: 0,
                }
            }
        },
        mounted: function(){
            let that = this;
            SeededShuffle.setSeed(this.seed);
            this.$nextTick(function () {
                // Code that will run only after the
                // entire view has been rendered
                this.resetTooltips();
                $.get( "resources/BadgeName-resources.assets-2134.txt", function( data ) {
                    // console.log(data);
                }).done(function(data){
                    that.badge_data = {};
                    let lines = data.split("\n");
                    for(let i = 0; i < lines.length; i++){
                        if(lines[i]){
                            let badge_info = lines[i].split("@");
                            that.badge_data[i] = {
                                id: i,
                                name: badge_info[0],
                                description: badge_info[1] ? that.replaceBulk(badge_info[1], Object.keys(that.game_data.description_find_replace), Object.values(that.game_data.description_find_replace)) : '[error: bad find/replace]',
                                type: badge_info[2],
                            };
                        }
                    }
                    that.reset();
                });
            });
        },
        methods: {
            reverseMessage: function () {
                this.message = this.message.split('').reverse().join('')
            },
            resetTooltips () {
                if(null === this.tooltips){
                    this.tooltips = $('body').tooltip({
                        selector: '[data-toggle="tooltip"]',
                    });
                } else {
                    $(this.tooltips).tooltip('toggle');
                    $(this.tooltips).tooltip('toggle');
                }
            },
            hideTips () {
                $(this.tooltips).tooltip('hide');
            },
            generate_from_seed () {
                SeededShuffle.setSeed(this.seed);
                let new_order = SeededShuffle.shuffle(this.game_data.mystery_medal_distribution, this.seed, true);
                this.bug_save.mystery_medals = [];
                for (let i = 0; i < new_order.length; i++) {
                    this.bug_save.mystery_medals.push(this.medalFromId(new_order[i], i));
                }
            },
            replaceBulk ( str, findArray, replaceArray ){
                let i, regex = [], map = {};
                for( i=0; i<findArray.length; i++ ){
                    regex.push( findArray[i].replace(/([-[\]{}()*+?.\\^$|#,])/g,'\\$1') );
                    map[findArray[i]] = replaceArray[i];
                }
                regex = regex.join('|');
                str = str.replace( new RegExp( regex, 'g' ), function(matched){
                    return map[matched];
                });
                return str;
            },
            encode_utf16: function (s, littleEndian) {
                let a = new Uint8Array(s.length * 2), view = new DataView(a.buffer);
                s.split('').forEach(function(c, i) {
                    view.setUint16(i * 2, c.charCodeAt(0), littleEndian);
                });
                return a;
            },
            /**
             * @return {string}
             */
            Encrypt: function (input) {
                let text = "";
                for (let i = 0; i < input.length; i++){
                    text += String.fromCharCode(input.charCodeAt(i) ^ this.game_data.encryption_key);
                }
                return new TextDecoder("utf-16").decode(this.encode_utf16(text, true));
            },
            dragOverHandler: function (ev) {
                // Prevent default behavior (Prevent file from being opened)
                ev.preventDefault();
            },
            generate_badge: function (ev) {
                ev.preventDefault();
                if(this.badge_generator_selection || this.badge_generator_selection == 0){
                    // noinspection JSUnusedGlobalSymbols
                    this.badge_generator_inventory = [this.medalFromId(this.badge_generator_selection, 0, false)];
                } else {
                    // noinspection JSUnusedGlobalSymbols
                    this.badge_generator_inventory = [];
                }
                this.resetTooltips();
            },
            /**
             * @return {boolean}
             */
            stringToBoolean (str) {
                if(str === 'True'){
                    return true;
                } else if(str === 'False'){
                    return false;
                }
            },
            /**
             * @return {string}
             */
            booleanToString (b) {
                if(b === true){
                    return 'True';
                } else if(b === false){
                    return 'False';
                }
            },
            saveAndDownload(data, filename, type) {
                let file = new Blob([data], {type: type});
                if (window.navigator.msSaveOrOpenBlob) // IE10+
                    window.navigator.msSaveOrOpenBlob(file, filename);
                else { // Others
                    let a = document.createElement("a"),
                        url = URL.createObjectURL(file);
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(function() {
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    }, 0);
                }
            },
            parseBugFile (text) {
                let bugSave = {
                    // array of booleans, save line 12
                    flags: [],
                    // array of strings, save line 13
                    flag_strings: [],

                    medals_party: [],
                    medals_inventory: [],
                    party_stat_bonuses: []
                };
                let lines = text.split("\n");

                // save file, line 1; position, mode icons, file name
                let splitbuffer = lines[0].split(",", 10);
                let chunkbuffer = [];
                let convertbuffer = [];

                bugSave.position = {
                    x: splitbuffer[0],
                    y: splitbuffer[1],
                    z: splitbuffer[2]
                };
                bugSave.modes = {
                    ruigee: splitbuffer[3],
                    hardest: splitbuffer[4],
                    frameone: splitbuffer[5],
                    morefarm: splitbuffer[6],
                    mystery: splitbuffer[7],
                    [5]: splitbuffer[8],
                };
                bugSave.profile_name = splitbuffer[9];

                // save file, line 2; character stats
                chunkbuffer = lines[1].split("@");
                bugSave.characters = [];
                for (let i = 0; i < this.game_data.character_count; i++) {
                    bugSave.characters[i] = {
                        trueid: i,
                        exists: false,
                        medals: [],
                        stat_bonuses: [],
                    }
                }
                for (let i = 0; i < chunkbuffer.length; i++) {
                    splitbuffer = chunkbuffer[i].split(",");
                    let character_id = parseInt(splitbuffer[0], 10);
                    bugSave.characters[character_id]['id'] = i;
                    bugSave.characters[character_id]['exists'] = true;
                    bugSave.characters[character_id]['trueid'] = character_id;
                    bugSave.characters[character_id]['hp'] = splitbuffer[1];
                    bugSave.characters[character_id]['maxhp'] = splitbuffer[2];
                    bugSave.characters[character_id]['basehp'] = splitbuffer[3];
                    bugSave.characters[character_id]['atk'] = splitbuffer[4];
                    bugSave.characters[character_id]['baseatvk'] = splitbuffer[5];
                    bugSave.characters[character_id]['def'] = splitbuffer[6];
                    bugSave.characters[character_id]['basedef'] =splitbuffer[7];
                }

                // save file, line 3; party stats
                splitbuffer = lines[2].split(",");
                bugSave.party_stats = {
                    partylevel: splitbuffer[0],
                    partyexp: splitbuffer[1],
                    neededexp: splitbuffer[2],
                    basetp: splitbuffer[3],
                    tp: splitbuffer[4],
                    money: parseInt(splitbuffer[5],10),
                    map_name: splitbuffer[6],
                    areaid: splitbuffer[7],
                    bp: splitbuffer[8],
                    maxbp: splitbuffer[9],
                    maxitems: splitbuffer[10],
                    maxstorage: splitbuffer[11],
                    clockhour: splitbuffer[12],
                    clockmin: splitbuffer[13],
                    clocksec: splitbuffer[14],
                    save_progress_icons: splitbuffer[15],
                };

                // save file, line 4; available badges
                chunkbuffer = lines[3].split("@");
                bugSave.available_badge_pools = [];
                for (let i = 0; i < chunkbuffer.length; i++) {
                    bugSave.available_badge_pools.push(chunkbuffer[i].split(","));
                }

                // save file, line 5; badge shops
                chunkbuffer = lines[4].split("@");
                bugSave.badge_shops = [];
                for (let i = 0; i < this.game_data.medal_shops_count; i++) {
                    bugSave.badge_shops[i] = [];
                }
                for (let i = 0; i < chunkbuffer.length; i++) {
                    bugSave.badge_shops[i] = [];
                    splitbuffer = chunkbuffer[i].split(",");
                    for (let j = 0; j < splitbuffer.length; j++) {
                        if(splitbuffer[j]){
                            bugSave.badge_shops[i].push(this.medalFromId(splitbuffer[j], j));
                        }
                    }
                }

                // save file, line 6; sidequests
                chunkbuffer = lines[5].split("@");
                bugSave.side_quests = [];
                for (let i = 0; i < chunkbuffer.length; i++) {
                    bugSave.side_quests.push(chunkbuffer[i].split(","));
                }

                // save file, line 7; items/inventory
                chunkbuffer = lines[6].split("@");
                bugSave.inventory = [];
                for (let i = 0; i < chunkbuffer.length; i++) {
                    bugSave.inventory.push(chunkbuffer[i].split(","));
                }

                // save file, line 8; badges in inventory
                chunkbuffer = lines[7].split("@");
                let medal = null;
                for (let i = 0; i < chunkbuffer.length; i++) {
                    splitbuffer = chunkbuffer[i].split(",");
                    if(splitbuffer[0]) {
                        medal = this.medalFromId(splitbuffer[0], i);
                        let character_id = parseInt(splitbuffer[1], 10);
                        if (character_id >= 0) {
                            bugSave.characters[character_id].medals.push(medal);
                        } else if (character_id === -1) {
                            bugSave.medals_party.push(medal);
                        } else if (character_id === -2) {
                            bugSave.medals_inventory.push(medal);
                        }
                    }
                }

                // save file, line 9; music
                chunkbuffer = lines[8].split("@");
                bugSave.music = [];
                for (let i = 0; i < chunkbuffer.length; i++) {
                    splitbuffer = chunkbuffer[i].split(",");
                    bugSave.music.push({
                        id: i,
                        song_id: splitbuffer[0],
                        bought: (splitbuffer[1] === '1') ? true : (splitbuffer[1] === '-1' ? false : null),
                    });
                }

                // save file, line 10; stat bonuses
                chunkbuffer = lines[9].split("@");
                for (let i = 0; i < chunkbuffer.length; i++) {
                    splitbuffer = chunkbuffer[i].split(",");
                    let character_id = parseInt(splitbuffer[2], 10);
                    if(character_id >= 0){
                        bugSave.characters[character_id].stat_bonuses.push({
                            type: splitbuffer[0],
                            amount: splitbuffer[1],
                        });
                    } else if(character_id === -1){
                        bugSave.party_stat_bonuses.push({
                            type: splitbuffer[0],
                            amount: splitbuffer[1],
                        });
                    }
                }

                // save file, line 11; library
                chunkbuffer = lines[10].split("@");
                bugSave.library = [];
                for (let i = 0; i < chunkbuffer.length; i++) {
                    splitbuffer = chunkbuffer[i].split(",");
                    convertbuffer = [];
                    for (let string of splitbuffer) {
                        convertbuffer.push(this.stringToBoolean(string));
                    }
                    bugSave.library.push(convertbuffer);
                }

                // save file, line 12; flags
                splitbuffer = lines[11].split(",");
                bugSave.flags = [];
                for (let string of splitbuffer) {
                    bugSave.flags.push(this.stringToBoolean(string));
                }

                // save file, line 13; flag strings
                bugSave.flag_strings = lines[12].split("|SPLIT|");

                // @TODO: flag_strings[0:12]
                splitbuffer = bugSave.flag_strings[13].split(",");
                bugSave.mystery_medals = [];
                for(let i = 0; i < splitbuffer.length; i++){
                    if(splitbuffer[i]) {
                        bugSave.mystery_medals.push(this.medalFromId(splitbuffer[i], i));
                    }
                }
                // @TODO: flag_strings[14] -- potentially a blank/redundant line?

                // save file, line 14; flag strings
                bugSave.flag_variables = lines[13].split(",");

                // save file, line 15; regional flags
                splitbuffer = lines[14].split(",");
                bugSave.regional_flags = [];
                for (let string of splitbuffer) {
                    bugSave.regional_flags.push(this.stringToBoolean(string));
                }

                // save file, line 16; crystal berries
                splitbuffer = lines[15].split(",");
                bugSave.crystal_berries = [];
                for (let string of splitbuffer) {
                    bugSave.crystal_berries.push(this.stringToBoolean(string));
                }

                // save file, line 17; extra followers
                bugSave.extra_followers = lines[16].split(",");

                // save file, line 18; enemy encounters
                chunkbuffer = lines[17].split("@");
                bugSave.enemy_encounters = [];
                for (let i = 0; i < chunkbuffer.length; i++) {
                    splitbuffer = chunkbuffer[i].split(",");
                    bugSave.enemy_encounters.push({
                        id: i,
                        seen_count: splitbuffer[0],
                        unknown_1: splitbuffer[1],
                    });
                }

                return bugSave;
            },
            writeBugFile (bugSave) {
                let lines = [];

                let joinbuffer = [];
                let weldbuffer = [];
                let convertbuffer = [];

                // save file, line 1; position, mode icons, file name
                lines[0] = '';
                joinbuffer = [
                    bugSave.position.x,
                    bugSave.position.y,
                    bugSave.position.z,
                    bugSave.modes.ruigee,
                    bugSave.modes.hardest,
                    bugSave.modes.frameone,
                    bugSave.modes.morefarm,
                    bugSave.modes.mystery,
                    bugSave.modes[5],
                    bugSave.profile_name
                ];
                lines[0] = joinbuffer.join(',');

                // save file, line 2; character stats
                lines[1] = '';
                weldbuffer = [];
                for (let i = 0; i < bugSave.characters.length; i++) {
                    let character = bugSave.characters[i];
                    if(character.exists) {
                        weldbuffer.push([
                            character['trueid'],
                            character['hp'],
                            character['maxhp'],
                            character['basehp'],
                            character['atk'],
                            character['baseatvk'],
                            character['def'],
                            character['basedef']
                        ].join(','));
                    }
                }
                lines[1] = weldbuffer.join('@');

                // save file, line 3; party stats
                lines[2] = [
                    bugSave.party_stats.partylevel,
                    bugSave.party_stats.partyexp,
                    bugSave.party_stats.neededexp,
                    bugSave.party_stats.basetp,
                    bugSave.party_stats.tp,
                    bugSave.party_stats.money,
                    bugSave.party_stats.map_name,
                    bugSave.party_stats.areaid,
                    bugSave.party_stats.bp,
                    bugSave.party_stats.maxbp,
                    bugSave.party_stats.maxitems,
                    bugSave.party_stats.maxstorage,
                    bugSave.party_stats.clockhour,
                    bugSave.party_stats.clockmin,
                    bugSave.party_stats.clocksec,
                    bugSave.party_stats.save_progress_icons
                ].join(',');

                // save file, line 4; available badges
                lines[3] = '';
                weldbuffer = [];
                for (let i = 0; i < bugSave.badge_shops.length; i++) {
                    joinbuffer = [];
                    for (let j = 0; j < bugSave.badge_shops[i].length; j++) {
                        joinbuffer.push(bugSave.badge_shops[i][j].medal_id);
                    }
                    weldbuffer.push(joinbuffer.join(','));
                }
                lines[3] = weldbuffer.join('@');

                // save file, line 5; badge shops
                lines[4] = lines[3];

                // save file, line 6; sidequests
                lines[5] = '';
                weldbuffer = [];
                for (let i = 0; i < bugSave.side_quests.length; i++) {
                    joinbuffer = [];
                    for (let j = 0; j < bugSave.side_quests[i].length; j++) {
                        joinbuffer.push(bugSave.side_quests[i][j]);
                    }
                    weldbuffer.push(joinbuffer.join(','));
                }
                lines[5] = weldbuffer.join('@');

                // save file, line 7; items/inventory
                lines[6] = '';
                weldbuffer = [];
                for (let i = 0; i < bugSave.inventory.length; i++) {
                    joinbuffer = [];
                    for (let j = 0; j < bugSave.inventory[i].length; j++) {
                        joinbuffer.push(bugSave.inventory[i][j]);
                    }
                    weldbuffer.push(joinbuffer.join(','));
                }
                lines[6] = weldbuffer.join('@');

                // save file, line 8; badges in inventory
                lines[7] = '';
                weldbuffer = [];
                for (let i = 0; i < bugSave.medals_inventory.length; i++) {
                    weldbuffer.push(bugSave.medals_inventory[i].medal_id+",-2");
                }
                for (let i = 0; i < bugSave.medals_party.length; i++) {
                    weldbuffer.push(bugSave.medals_party[i].medal_id+",-1");
                }
                for (let i = 0; i < bugSave.characters.length; i++) {
                    joinbuffer = [];
                    for (let j = 0; j < bugSave.characters[i].medals.length; j++) {
                        weldbuffer.push(bugSave.characters[i].medals[j].medal_id+","+bugSave.characters[i].trueid);
                    }
                }
                lines[7] = weldbuffer.join('@');

                // save file, line 9; music
                lines[8] = '';
                weldbuffer = [];
                for (let i = 0; i < bugSave.music.length; i++) {
                    let song = bugSave.music[i];
                    weldbuffer.push(
                        song.song_id+","+(song.bought ? '1' : '-1')
                    );
                }
                lines[8] = weldbuffer.join('@');

                // save file, line 10; stat bonuses
                lines[9] = '';
                weldbuffer = [];
                for (let i = 0; i < bugSave.party_stat_bonuses.length; i++) {
                    let bonus = bugSave.party_stat_bonuses[i];
                    weldbuffer.push(bonus.type+","+bonus.amount+",-1");
                }
                for (let i = 0; i < bugSave.characters.length; i++) {
                    let character = bugSave.characters[i];
                    if(character.exists){
                        for (let j = 0; j < character.stat_bonuses.length; j++) {
                            let bonus = character.stat_bonuses[j];
                            weldbuffer.push(bonus.type+","+bonus.amount+","+character.trueid);
                        }
                    }
                }
                lines[9] = weldbuffer.join('@');

                // save file, line 11; library
                lines[10] = '';
                weldbuffer = [];
                for (let i = 0; i < bugSave.library.length; i++) {
                    convertbuffer = [];
                    for (let j = 0; j < bugSave.library[i].length; j++) {
                        convertbuffer.push(this.booleanToString(bugSave.library[i][j]));
                    }
                    weldbuffer.push(convertbuffer.join(','));
                }
                lines[10] = weldbuffer.join('@');

                // save file, line 12; flags
                lines[11] = '';
                joinbuffer = [];
                for (let flag of bugSave.flags) {
                    joinbuffer.push(this.booleanToString(flag));
                }
                lines[11] = joinbuffer.join(',');

                // save file, line 13; flag strings
                lines[12] = '';
                weldbuffer = [];
                // @TODO: flag_strings[0:12]
                joinbuffer = [];
                for(let i = 0; i < bugSave.mystery_medals.length; i++){
                    joinbuffer.push(bugSave.mystery_medals[i].medal_id);
                }
                bugSave.flag_strings[13] = joinbuffer.join(',');
                // @TODO: flag_strings[14] -- potentially a blank/redundant line?
                lines[12] = bugSave.flag_strings.join("|SPLIT|");

                // save file, line 14; flag strings
                lines[13] = bugSave.flag_variables.join(',');

                // save file, line 15; regional flags
                lines[14] = '';
                joinbuffer = [];
                for (let regional_flag of bugSave.regional_flags) {
                    joinbuffer.push(this.booleanToString(regional_flag));
                }
                lines[14] = joinbuffer.join(',');

                // save file, line 16; crystal berries
                lines[15] = '';
                joinbuffer = [];
                for (let crystal_berry of bugSave.crystal_berries) {
                    joinbuffer.push(this.booleanToString(crystal_berry));
                }
                lines[15] = joinbuffer.join(',');

                // save file, line 17; extra followers
                lines[16] = bugSave.extra_followers.join(',');

                // save file, line 18; enemy encounters
                lines[17] = [];
                weldbuffer = [];
                for (let i = 0; i < bugSave.enemy_encounters.length; i++) {
                    let enemy = bugSave.enemy_encounters[i];
                    weldbuffer.push(enemy.seen_count+","+enemy.unknown_1);
                }
                lines[17] = weldbuffer.join('@');
                return lines.join("\n");
            },
            medalFromId(id, index, overrideSecret) {
                // debugger;
                overrideSecret = (typeof overrideSecret !== 'undefined') ? overrideSecret : !this.spoilers;
                if(!(id in Object.keys(this.badge_data))){
                    return {
                        id: index,
                        medal_id: id,
                        secret: true,
                        name: "broken medal",
                        description: "corrupted save or an application error",
                        type: "an",
                    }
                } else {
                    return {
                        id: index,
                        medal_id: id,
                        secret: overrideSecret,
                        name: this.badge_data[id].name,
                        description: this.badge_data[id].description,
                        type: this.badge_data[id].type,
                    }
                }
            },
            reset () {
                this.bug_save = JSON.parse(JSON.stringify(this.proto_bug_save));
                this.seed = new Date().getTime();
                this.generate_from_seed();
                this.bug_save.profile_name = this.seed;
            },
            save () {
                let bugData = this.writeBugFile(this.bug_save);
                // bugData = this.Encrypt(bugData);
                this.saveAndDownload(bugData, this.file_name+".out", 'application/x-binary');
            },
            async dropHandler (ev) {
                // Prevent default behavior (Prevent file from being opened)
                ev.preventDefault();
                if (ev.dataTransfer.items) {
                    // Use DataTransferItemList interface to access the file(s)
                    for (let i = 0; i < ev.dataTransfer.items.length; i++) {
                        // If dropped items aren't files, reject them
                        if (ev.dataTransfer.items[i].kind === 'file') {
                            /*data[i].getAsString(function (s){
                                ev.target.appendChild(document.getElementById(s));
                            });*/
                            let file = ev.dataTransfer.items[i].getAsFile();
                            this.file_name = file.name;
                            console.log('loading "' + file.name + '" for use');
                            this.bug_save = this.parseBugFile(this.Encrypt(await file.text()));
                        }
                    }
                } else {
                    // Use DataTransfer interface to access the file(s)
                    for (let i = 0; i < ev.dataTransfer.files.length; i++) {
                        console.log('... file[' + i + '].name = ' + ev.dataTransfer.files[i].name);
                    }
                }
                return new Promise(function(){ return true; });
            }
        },
    })
</script>
</body>
</html>